#!/bin/bash
# sanitize_csv_encoding.sh v2 ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ UTF-16 –∏ BOM
INPUT="$1"
OUT="${INPUT%.csv}_clean.csv"

if [ ! -f "$INPUT" ]; then
  echo "‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: $INPUT" >&2
  exit 1
fi

# –ü–æ–ø—Ä–æ–±—É–µ–º –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–¥–∏—Ä–æ–≤–∫—É (–µ—Å–ª–∏ –µ—Å—Ç—å 'file' ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
ENC=$(file -bi "$INPUT" 2>/dev/null | cut -d= -f2)
[ -z "$ENC" ] && ENC="utf-16"

# –ü—Ä–æ–±—É–µ–º —Å–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ UTF-8 –∏–∑ UTF-16 –∏–ª–∏ —É–∫–∞–∑–∞–Ω–Ω–æ–π –∫–æ–¥–∏—Ä–æ–≤–∫–∏
if iconv -f "$ENC" -t utf-8 "$INPUT" > "$OUT" 2>/dev/null; then
  echo "‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –∏–∑ $ENC –≤ UTF-8: $OUT"
else
  echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–¥–∏—Ä–æ–≤–∫—É, –ø—Ä–æ–±—É–µ–º UTF-16LE ‚Üí UTF-8"
  iconv -f UTF-16LE -t UTF-8 "$INPUT" > "$OUT" 2>/dev/null || {
    echo "‚ùå –û—à–∏–±–∫–∞ iconv" >&2
    exit 1
  }
fi

# –£–¥–∞–ª–∏–º –Ω–µASCII —Å–∏–º–≤–æ–ª—ã, –∫—Ä–æ–º–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö
sed -i 's/[^[:print:],;._@{}()\[\]<>-]/ /g' "$OUT"

echo "üìé –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä:"
head -n 2 "$OUT" | cat -v
